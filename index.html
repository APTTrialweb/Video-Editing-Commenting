<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simple Video Review ‚Äî Assigned To + Share Link + Export</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#0f1724;color:#e6eef8;margin:0;padding:20px}
    h1{color:#06b6d4}
    video{width:100%;max-width:800px;border-radius:8px;background:#000;margin-top:20px}
    input,button,textarea{font-family:inherit}
    input[type=text]{width:100%;padding:10px;border-radius:8px;border:none;margin-top:8px;margin-bottom:8px}
    button{background:#06b6d4;color:#042;padding:10px 16px;border:none;border-radius:8px;cursor:pointer;font-weight:bold}
    button.ghost{background:transparent;border:1px solid #06b6d4;color:#06b6d4}
    .comment-box{margin-top:20px}
    textarea{width:100%;height:70px;border-radius:8px;border:none;padding:10px;margin-top:8px}
    ul{list-style:none;padding:0;margin:0;margin-top:10px}
    li{background:#152238;padding:8px;border-radius:8px;margin-bottom:6px}
    .time-link{color:#06b6d4;cursor:pointer;text-decoration:underline}
    .readonly-note{background:#152238;padding:10px;border-radius:8px;margin-top:20px;color:#94a3b8}
  </style>
</head>
<body>
  <h1>DIY Video Review (Assigned To + Share Link + Export)</h1>
  <p>Paste your <strong>Dropbox</strong>, <strong>GoFile</strong>, or any direct video URL below. The app auto-converts links and lets you add timestamped comments.</p>

  <input id="videoURL" type="text" placeholder="Paste direct .mp4 or share link here">
  <button id="btnLoad">Load Video</button>

  <video id="video" controls></video>

  <div id="editSection" class="comment-box">
    <h3>Add Comment</h3>
    <textarea id="commentText" placeholder="Type comment..."></textarea>
    <button id="btnAdd">Add Comment at Current Time</button>
    <button id="btnExport" class="ghost">Export Comments</button>
    <br><br>
    <input id="editorName" type="text" placeholder="Assigned To (Editor Name)">
    <button id="btnShare" class="ghost">Generate Share Link & Assign</button>
  </div>

  <div id="shareBox" class="readonly-note" style="display:none;"></div>

  <h3>Comments</h3>
  <ul id="commentList"></ul>

  <script>
    const video = document.getElementById('video');
    const videoURL = document.getElementById('videoURL');
    const btnLoad = document.getElementById('btnLoad');
    const commentText = document.getElementById('commentText');
    const btnAdd = document.getElementById('btnAdd');
    const commentList = document.getElementById('commentList');
    const btnExport = document.getElementById('btnExport');
    const btnShare = document.getElementById('btnShare');
    const editSection = document.getElementById('editSection');
    const shareBox = document.getElementById('shareBox');
    const editorName = document.getElementById('editorName');

    // üü¢ Replace this with your deployed Google Apps Script URL:
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxTr4I4mydhvd8cGPjoYBlu1psYMcpyqL7Bee77gQHvpnGdqHNaoCTuNPZYLEUqguN8QQ/exec";

    // Format seconds ‚Üí hh:mm:ss
    function formatTime(seconds){
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = Math.floor(seconds % 60);
      const pad = n => n.toString().padStart(2,'0');
      return `${pad(h)}:${pad(m)}:${pad(s)}`;
    }

    // Detect Dropbox / GoFile links
    function makePlayableURL(url){
      if(!url) return '';
      let finalURL = url.trim();

      if(finalURL.includes('dropbox.com')){
        finalURL = finalURL.replace('www.dropbox.com','dl.dropboxusercontent.com');
        finalURL = finalURL.replace('?dl=0','');
      }

      if(finalURL.includes('gofile.io/d/')){
        const id = finalURL.split('/d/')[1]?.split(/[/?#]/)[0];
        if(id){
          const apiURL = `https://corsproxy.io/?https://api.gofile.io/getContent?contentId=${id}`;
          fetch(apiURL)
            .then(r=>r.json())
            .then(data=>{
              if(data.status==='ok' && data.data && data.data.contents){
                const files = Object.values(data.data.contents);
                const firstFile = files.find(f=>f.link?.endsWith('.mp4')) || files[0];
                if(firstFile){
                  video.src = `https://corsproxy.io/?${firstFile.link}`;
                  video.load();
                } else alert('No playable .mp4 found in this GoFile folder');
              } else alert('Could not fetch GoFile data');
            })
            .catch(()=>alert('Error fetching GoFile data'));
          return '';
        }
      }
      if(finalURL.includes('store') && finalURL.includes('gofile.io')){
        finalURL = `https://corsproxy.io/?${finalURL}`;
      }
      return finalURL;
    }

    btnLoad.addEventListener('click', ()=>{
      const url = videoURL.value.trim();
      const playable = makePlayableURL(url);
      if(playable){
        video.src = playable;
        video.load();
      }
    });

    // Local comment system
    function key(){return 'review:'+(video.src||videoURL.value);}
    function loadComments(){try{return JSON.parse(localStorage.getItem(key())||'[]');}catch(e){return []}}
    function saveComments(arr){localStorage.setItem(key(),JSON.stringify(arr));}

    function renderComments(){
      const comments = loadComments();
      commentList.innerHTML = '';
      comments.sort((a,b)=>a.time-b.time);
      for(const c of comments){
        const li=document.createElement('li');
        li.innerHTML=`<span class='time-link' data-time='${c.time}'>${formatTime(c.time)}</span> - ${c.text}`;
        commentList.appendChild(li);
      }
    }

    btnAdd.addEventListener('click', ()=>{
      if(!video.src){alert('Load a video first');return;}
      const t=video.currentTime;
      const txt=commentText.value.trim();
      if(!txt)return;
      const arr=loadComments();
      arr.push({time:t,text:txt});
      saveComments(arr);
      commentText.value='';
      renderComments();
    });

    commentList.addEventListener('click', e=>{
      if(e.target.classList.contains('time-link')){
        const t=parseFloat(e.target.dataset.time);
        video.currentTime=t;
        video.play();
      }
    });

    // Export comments
    btnExport.addEventListener('click', ()=>{
      const comments = loadComments();
      if(!comments.length){alert('No comments to export');return;}
      const data = {video: video.src || videoURL.value, comments};
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'comments.json';
      a.click();
      URL.revokeObjectURL(url);
    });

    // üîπ Generate share link + TinyURL shortener + log to Google Sheets
    btnShare.addEventListener('click', async ()=>{
      const comments = loadComments();
      const editor = editorName.value.trim();
      if(!comments.length){alert('No comments to share');return;}
      if(!editor){alert('Please enter the editor name before generating link');return;}

      const data = {video: video.src || videoURL.value, comments};
      const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(data))));
      const longLink = `${location.origin}${location.pathname}?data=${encoded}`;

      try {
        // Create short link via TinyURL API (free fallback)
        let shortLink = '';
        try {
          const res = await fetch(`https://tinyurl.com/api-create.php?url=${encodeURIComponent(longLink)}`);
          shortLink = await res.text();
        } catch (err) {
          shortLink = longLink; // fallback if API fails
        }

        // Display short link
        shareBox.style.display='block';
        shareBox.innerHTML = `<strong>Link assigned to ${editor}:</strong><br>
          <input type='text' value='${shortLink}' style='width:100%;margin-top:6px;padding:6px;border-radius:6px;border:none;'>`;

        // Log to Google Sheet
        fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            editor: editor,
            video: video.src || videoURL.value,
            shareLink: shortLink
          })
        }).then(()=> console.log("Logged to Google Sheet"))
          .catch(err=> console.error("Error logging:", err));

        // Copy to clipboard
        navigator.clipboard.writeText(shortLink).then(()=>{
          alert("‚úÖ Short link copied!");
        }).catch(()=>{});

      } catch (err) {
        console.error("Error creating short link:", err);
        alert("‚ùå Error creating short link");
      }
    });

    // Read-only mode for shared links
    const params = new URLSearchParams(location.search);
    if(params.has('data')){
      try{
        const decoded = decodeURIComponent(escape(atob(params.get('data'))));
        const parsed = JSON.parse(decoded);
        if(parsed.video){
          video.src = parsed.video;
          video.load();
          localStorage.setItem(key(), JSON.stringify(parsed.comments||[]));
          renderComments();
          editSection.style.display='none';
          shareBox.style.display='block';
          shareBox.innerHTML='<strong>Read-only mode:</strong> You are viewing shared comments.';
        }
      }catch(e){
        console.error('Error loading shared data:', e);
      }
    } else {
      renderComments();
    }
  </script>
</body>
</html>
